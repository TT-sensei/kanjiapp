<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>3„Å≠„Çì„Åõ„ÅÑ „Åã„Çì„Åò„Éû„Çπ„Çø„ÉºÔºà„Åã„Çì„Å∫„ÅçÁâàÔºâ</title>
    
    <script src="https://cdn.jsdelivr.net/npm/hanzi-writer@3.5/dist/hanzi-writer.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">

    <style>
        /* --- „Éá„Ç∂„Ç§„É≥Ë®≠ÂÆöÔºà„ÉÜ„Éº„ÉûÔºöÁ©∫„Å®Êµ∑Ôºâ --- */
        body {
            font-family: 'Mochiy Pop One', sans-serif;
            background-color: #E3F2FD;
            margin: 0; padding: 0;
            min-height: 100vh;
            color: #0D47A1;
            overflow-x: hidden;
            touch-action: manipulation;
            user-select: none;
        }

        /* ÁîªÈù¢ÂÖ±ÈÄö */
        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%; min-height: 100vh;
            padding: 20px; box-sizing: border-box;
            opacity: 0; transition: opacity 0.3s;
        }
        .screen.active { display: flex; opacity: 1; }

        /* „Çø„Ç§„Éà„É´ÁîªÈù¢ */
        #title-screen { background: linear-gradient(135deg, #42A5F5 0%, #1E88E5 100%); }
        .game-title {
            font-size: 2.8rem; color: #FFF; text-shadow: 3px 3px 0px #01579B;
            text-align: center; margin-bottom: 40px; line-height: 1.2;
        }
        .mode-btn {
            width: 280px; font-size: 1.4rem; padding: 15px 0;
            border-radius: 50px; border: none; cursor: pointer;
            margin: 10px 0; color: white; font-family: inherit;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            transition: transform 0.1s; box-shadow: 0 6px 0 rgba(0,0,0,0.2);
        }
        .mode-btn:active { transform: scale(0.95); box-shadow: 0 3px 0 rgba(0,0,0,0.2); }
        .btn-practice { background-color: #FFCA28; color: #333; }
        .btn-test { background-color: #FF7043; }

        /* ‰∏ÄË¶ßÁîªÈù¢ */
        #list-screen { justify-content: flex-start; padding-top: 20px; }
        .header-info {
            background: white; padding: 15px; border-radius: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); margin-bottom: 20px;
            display: flex; flex-direction: column; align-items: center;
            width: 90%; max-width: 600px;
        }
        .mode-badge {
            font-size: 1rem; padding: 5px 15px; border-radius: 20px;
            color: white; margin-bottom: 5px; font-weight: bold;
        }
        
        #search-input {
            width: 80%; padding: 10px; font-size: 1.2rem; margin: 10px 0;
            border: 2px solid #64B5F6; border-radius: 10px;
            font-family: inherit; text-align: center; outline: none;
            background-color: #F1F8E9;
        }
        #search-input:focus { border-color: #1565C0; background-color: #FFF; }

        .kanji-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(65px, 1fr));
            gap: 12px; width: 100%; max-width: 800px; padding-bottom: 50px;
        }
        .kanji-card {
            background: white; aspect-ratio: 1 / 1; border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            font-size: 2rem; cursor: pointer; box-shadow: 0 4px 0px #90CAF9;
            position: relative; border: 2px solid transparent;
        }
        .kanji-card:active { transform: translateY(2px); box-shadow: 0 2px 0px #90CAF9; }
        .mark {
            position: absolute; top: -8px; right: -8px; font-size: 1.4rem;
            text-shadow: 1px 1px 0 #FFF; display: none; z-index: 2;
        }
        .kanji-card.cleared-practice { background-color: #FFF8E1; border-color: #FFCA28; }
        .kanji-card.cleared-practice .star-mark { display: block; }
        .kanji-card.cleared-test { background-color: #FFCCBC; border-color: #FF7043; }
        .kanji-card.cleared-test .crown-mark { display: block; }

        /* Á∑¥ÁøíÁîªÈù¢ */
        #practice-screen { background-color: #E3F2FD; position: relative; }
        #practice-screen.test-bg { background-color: #FFEBEE; }
        .practice-header {
            width: 100%; max-width: 600px; display: flex;
            justify-content: space-between; align-items: center; margin-bottom: 10px;
        }
        .nav-btn {
            background: #546E7A; color: white; border: none; padding: 8px 16px;
            border-radius: 20px; cursor: pointer; font-family: inherit;
            box-shadow: 0 3px 0 #37474F; white-space: nowrap;
        }
        .nav-btn:active { transform: translateY(2px); box-shadow: 0 1px 0 #37474F; }

        /* Ë™≠„ÅøË°®Á§∫„Ç®„É™„Ç¢ */
        .reading-container {
            flex-grow: 1; text-align: center; padding: 0 10px;
            display: flex; flex-direction: column; justify-content: center;
        }
        .target-char-display { 
            font-size: 2.2rem; color: #01579B; font-weight: bold; 
            line-height: 1.2;
        }
        .reading-detail {
            font-size: 0.95rem; color: #455A64; margin-top: 5px;
            line-height: 1.4; word-break: keep-all;
        }

        .canvas-container {
            background: white; padding: 10px; border-radius: 20px;
            box-shadow: 0 6px 0px #90CAF9; margin-bottom: 15px; position: relative;
        }
        #character-target-div { width: 280px; height: 280px; touch-action: none; }
        #message-area { height: 30px; font-size: 1.2rem; color: #333; text-align: center; font-weight: bold; }
        
        /* „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .reward-animation {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 10rem; animation: pop 0.5s ease-out; pointer-events: none;
            display: none; z-index: 100; text-shadow: 0 0 20px rgba(255, 255, 255, 0.8);
        }

        /* ÁµêÊûú„É°„Éã„É•„Éº */
        #result-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.95); display: none;
            flex-direction: column; align-items: center; justify-content: center;
            z-index: 200; border-radius: 20px;
        }
        #result-overlay.active { display: flex; }

        .result-title { font-size: 2.5rem; margin-bottom: 20px; text-shadow: 2px 2px 0 #FFF; }
        .result-btn {
            width: 220px; padding: 12px; margin: 8px 0; border: none; border-radius: 50px;
            font-size: 1.1rem; font-family: inherit; color: white; cursor: pointer;
            box-shadow: 0 4px 0 rgba(0,0,0,0.2); transition: transform 0.1s;
        }
        .result-btn:active { transform: scale(0.95); }
        .btn-next { background: #29B6F6; } 
        .btn-retry { background: #FFCA28; color: #333; }
        .btn-home { background: #78909C; }

    </style>
</head>
<body>

    <div id="title-screen" class="screen active">
        <div class="game-title">3„Å≠„Çì„Åõ„ÅÑ<br>„Åã„Çì„Åò<br>„Éû„Çπ„Çø„Éº</div>
        <button class="mode-btn btn-practice" onclick="selectMode('practice')"><span>‚≠ê</span> „Çå„Çì„Åó„ÇÖ„ÅÜ</button>
        <button class="mode-btn btn-test" onclick="selectMode('test')"><span>üëë</span> „ÉÜ„Çπ„Éà</button>
    </div>

    <div id="list-screen" class="screen">
        <div class="header-info">
            <div id="mode-display" class="mode-badge"></div>
            <input type="text" id="search-input" placeholder="„Åï„Åå„ÅôÔºà„Åã„Çì„Åò„Éª„Çà„ÅøÔºâ" oninput="renderList()">
            <div style="font-size:1.1rem; margin-top:5px;">
                „ÅÇ„Å§„ÇÅ„ÅüÊï∞Ôºö <span id="star-counter" style="font-size:1.4rem; font-weight:bold;">0</span> / 200
            </div>
            <button class="nav-btn" onclick="showScreen('title-screen')" style="margin-top:10px; font-size:0.8rem;">„Çø„Ç§„Éà„É´„Å∏</button>
        </div>
        <div class="kanji-grid" id="kanji-grid"></div>
        <button class="nav-btn" onclick="resetData()" style="margin-top:30px; background:#B0BEC5; font-size:0.7rem;">„Éá„Éº„Çø„ÇíÊ∂à„Åô</button>
    </div>

    <div id="practice-screen" class="screen">
        <div class="practice-header">
            <button class="nav-btn" onclick="showScreen('list-screen')">„ÇÇ„Å©„Çã</button>
            <div class="reading-container">
                <div id="current-kanji-title" class="target-char-display">Êº¢Â≠ó</div>
                <div id="current-reading-detail" class="reading-detail">„Çà„Åø</div>
            </div>
            <div style="width: 50px;"></div>
        </div>
        <div class="canvas-container">
            <div id="character-target-div"></div>
            <div id="anim-star" class="reward-animation">‚≠ê</div>
            <div id="anim-crown" class="reward-animation">üëë</div>
        </div>
        <div id="message-area">„Å™„Åû„Å£„Å¶„Åø„Çà„ÅÜÔºÅ</div>
        
        <div id="result-overlay">
            <div class="result-title" id="result-title-text">„Åß„Åç„ÅüÔºÅ</div>
            <button class="result-btn btn-next" onclick="goNext()">„Å§„Åé„ÅÆ „Åã„Çì„Åò ‚ñ∂</button>
            <button class="result-btn btn-retry" onclick="retry()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å© ‚Ü∫</button>
            <button class="result-btn btn-home" onclick="showScreen('list-screen')">„Éõ„Éº„É†„Å´„ÇÇ„Å©„Çã üè†</button>
        </div>
        
        <button class="nav-btn" onclick="retry()" style="background:#FF7043; margin-top:10px; z-index:10;">Êõ∏„ÅçÁõ¥„Åô</button>
    </div>

    <script>
        // --- 3Âπ¥ÁîüÊº¢Â≠ó„Éá„Éº„Çø (200ÊñáÂ≠ó„ÉªÂÆåÂÖ®Ë©≥Á¥∞Áâà) ---
        // „Éï„Ç©„Éº„Éû„ÉÉ„Éà: "Êº¢Â≠ó:Èü≥Ë™≠„Åø(„Ç´„Çø„Ç´„Éä)„Éª„Åè„Çì„Çà„Åø(„Å≤„Çâ„Åå„Å™)"
        // Ë§áÊï∞„ÅÆË™≠„Åø„ÅØ„Äå„Éª„Äç„ÅßÂå∫Âàá„Çä„ÄÅÈÄÅ„Çä‰ªÆÂêç„ÅØ()„ÅßÂõ≤„Çì„Åß„ÅÑ„Åæ„Åô„ÄÇ
        const kanjiString = 
            "ÊÇ™:„Ç¢„ÇØ„Éª„Ç™„Éª„Çè„Çã(„ÅÑ),ÂÆâ:„Ç¢„É≥„Éª„ÇÑ„Åô(„ÅÑ),Êöó:„Ç¢„É≥„Éª„Åè„Çâ(„ÅÑ),Âåª:„Ç§,Âßî:„Ç§„Éª„ÇÜ„Å†(„Å≠„Çã),ÊÑè:„Ç§,ËÇ≤:„Ç§„ÇØ„Éª„Åù„Å†(„Å§)„Éª„Åù„Å†(„Å¶„Çã),Âì°:„Ç§„É≥,Èô¢:„Ç§„É≥,È£≤:„Ç§„É≥„Éª„ÅÆ(„ÇÄ),ÈÅã:„Ç¶„É≥„Éª„ÅØ„Åì(„Å∂),Ê≥≥:„Ç®„Ç§„Éª„Åä„Çà(„Åê),ÈßÖ:„Ç®„Ç≠,Â§Æ:„Ç™„Ç¶,Ê®™:„Ç™„Ç¶„Éª„Çà„Åì,Â±ã:„Ç™„ÇØ„Éª„ÇÑ,Ê∏©:„Ç™„É≥„Éª„ÅÇ„Åü„Åü(„Åã)„Éª„ÅÇ„Åü„Åü(„Åã„ÅÑ)„Éª„ÅÇ„Åü„Åü(„Åæ„Çã)„Éª„ÅÇ„Åü„Åü(„ÇÅ„Çã),Âåñ:„Ç´„Éª„Ç±„Éª„Å∞(„Åë„Çã)„Éª„Å∞(„Åã„Åô),Ëç∑:„Ç´„Éª„Å´,Áïå:„Ç´„Ç§,Èñã:„Ç´„Ç§„Éª„Å≤„Çâ(„Åè)„Éª„Å≤„Çâ(„Åë„Çã)„Éª„ÅÇ(„Åè)„Éª„ÅÇ(„Åë„Çã),Èöé:„Ç´„Ç§,ÂØí:„Ç´„É≥„Éª„Åï„ÇÄ(„ÅÑ),ÊÑü:„Ç´„É≥,Êº¢:„Ç´„É≥,È§®:„Ç´„É≥„Éª„ÇÑ„Åã„Åü,Â≤∏:„Ç¨„É≥„Éª„Åç„Åó,Ëµ∑:„Ç≠„Éª„Åä(„Åç„Çã)„Éª„Åä(„Åì„Åô),Êúü:„Ç≠„Éª„Ç¥,ÂÆ¢:„Ç≠„É£„ÇØ„Éª„Ç´„ÇØ,Á©∂:„Ç≠„É•„Ç¶„Éª„Åç„Çè(„ÇÅ„Çã),ÊÄ•:„Ç≠„É•„Ç¶„Éª„ÅÑ„Åù(„Åê),Á¥ö:„Ç≠„É•„Ç¶,ÂÆÆ:„Ç≠„É•„Ç¶„Éª„Ç∞„Ç¶„Éª„ÇØ„Éª„Åø„ÇÑ,ÁêÉ:„Ç≠„É•„Ç¶„Éª„Åü„Åæ,Âéª:„Ç≠„Éß„Éª„Ç≥„Éª„Åï(„Çã),Ê©ã:„Ç≠„Éß„Ç¶„Éª„ÅØ„Åó,Ê•≠:„ÇÆ„Éß„Ç¶„Éª„Ç¥„Ç¶„Éª„Çè„Åñ,Êõ≤:„Ç≠„Éß„ÇØ„Éª„Åæ(„Åå„Çã)„Éª„Åæ(„Åí„Çã),Â±Ä:„Ç≠„Éß„ÇØ,ÈäÄ:„ÇÆ„É≥,Âå∫:„ÇØ,Ëã¶:„ÇØ„Éª„Åè„Çã(„Åó„ÅÑ)„Éª„Åè„Çã(„Åó„ÇÄ)„Éª„Å´„Åå(„ÅÑ)„Éª„Å´„Åå(„Çã),ÂÖ∑:„Ç∞,Âêõ:„ÇØ„É≥„Éª„Åç„Åø,‰øÇ:„Ç±„Ç§„Éª„Åã„Åã(„Çã)„Éª„Åã„Åã„Çä,ËªΩ:„Ç±„Ç§„Éª„Åã„Çã(„ÅÑ)„Éª„Åã„Çç(„ÇÑ„Åã),Ë°Ä:„Ç±„ÉÑ„Éª„Å°,Ê±∫:„Ç±„ÉÑ„Éª„Åç(„ÇÅ„Çã)„Éª„Åç(„Åæ„Çã),Á†î:„Ç±„É≥„Éª„Å®(„Åê),Áúå:„Ç±„É≥,Â∫´:„Ç≥„Éª„ÇØ,Êπñ:„Ç≥„Éª„Åø„Åö„ÅÜ„Åø,Âêë:„Ç≥„Ç¶„Éª„ÇÄ(„Åè)„Éª„ÇÄ(„Åë„Çã)„Éª„ÇÄ(„Åã„ÅÜ)„Éª„ÇÄ(„Åì„ÅÜ),Âπ∏:„Ç≥„Ç¶„Éª„Åï„ÅÑ„Çè(„ÅÑ)„Éª„Åï„Å°„Éª„Åó„ÅÇ„Çè(„Åõ),Ê∏Ø:„Ç≥„Ç¶„Éª„Åø„Å™„Å®,Âè∑:„Ç¥„Ç¶,Ê†π:„Ç≥„É≥„Éª„Å≠,Á•≠:„Çµ„Ç§„Éª„Åæ„Å§(„Çã)„Éª„Åæ„Å§(„Çä),Áöø:„Åï„Çâ,‰ªï:„Ç∑„Éª„Ç∏„Éª„Å§„Åã(„Åà„Çã),Ê≠ª:„Ç∑„Éª„Åó(„Å¨),‰Ωø:„Ç∑„Éª„Å§„Åã(„ÅÜ),Âßã:„Ç∑„Éª„ÅØ„Åò(„ÇÅ„Çã)„Éª„ÅØ„Åò(„Åæ„Çã),Êåá:„Ç∑„Éª„ÇÜ„Å≥„Éª„Åï(„Åô),Ê≠Ø:„Ç∑„Éª„ÅØ,Ë©©:„Ç∑,Ê¨°:„Ç∏„Éª„Ç∑„Éª„Å§„Åé„Éª„Å§(„Åê),‰∫ã:„Ç∏„Éª„Ç∫„Éª„Åì„Å®,ÊåÅ:„Ç∏„Éª„ÇÇ(„Å§),Âºè:„Ç∑„Ç≠,ÂÆü:„Ç∏„ÉÑ„Éª„Åø„Éª„Åø„ÅÆ(„Çã),ÂÜô:„Ç∑„É£„Éª„ÅÜ„Å§(„Åô)„Éª„ÅÜ„Å§(„Çã),ËÄÖ:„Ç∑„É£„Éª„ÇÇ„ÅÆ,‰∏ª:„Ç∑„É•„Éª„Çπ„Éª„Å¨„Åó„Éª„Åä„ÇÇ,ÂÆà:„Ç∑„É•„Éª„Çπ„Éª„Åæ„ÇÇ(„Çã)„Éª„ÇÇ(„Çä),Âèñ:„Ç∑„É•„Éª„Å®(„Çã),ÈÖí:„Ç∑„É•„Éª„Åï„Åë„Éª„Åï„Åã,Âèó:„Ç∏„É•„Éª„ÅÜ(„Åë„Çã)„Éª„ÅÜ(„Åã„Çã),Â∑û:„Ç∑„É•„Ç¶„Éª„Åô,Êãæ:„Ç∑„É•„Ç¶„Éª„Ç∏„É•„Ç¶„Éª„Å≤„Çç(„ÅÜ),ÁµÇ:„Ç∑„É•„Ç¶„Éª„Åä(„Çè„Çã)„Éª„Åä(„Åà„Çã),Áøí:„Ç∑„É•„Ç¶„Éª„Å™„Çâ(„ÅÜ),ÈõÜ:„Ç∑„É•„Ç¶„Éª„ÅÇ„Å§(„ÇÅ„Çã)„Éª„ÅÇ„Å§(„Åæ„Çã),‰Ωè:„Ç∏„É•„Ç¶„Éª„Åô(„ÇÄ)„Éª„Åô(„Åæ„ÅÜ),Èáç:„Ç∏„É•„Ç¶„Éª„ÉÅ„Éß„Ç¶„Éª„Åà„Éª„Åä„ÇÇ(„ÅÑ)„Éª„Åã„Åï(„Å≠„Çã)„Éª„Åã„Åï(„Å™„Çã),ÂÆø:„Ç∑„É•„ÇØ„Éª„ÇÑ„Å©„Éª„ÇÑ„Å©(„Çã)„Éª„ÇÑ„Å©(„Åô),ÊâÄ:„Ç∑„Éß„Éª„Å®„Åì„Çç,Êöë:„Ç∑„Éß„Éª„ÅÇ„Å§(„ÅÑ),Âä©:„Ç∏„Éß„Éª„Åü„Åô(„Åë„Çã)„Éª„Åü„Åô(„Åã„Çã)„Éª„Åô„Åë,Êò≠:„Ç∑„Éß„Ç¶,Ê∂à:„Ç∑„Éß„Ç¶„Éª„Åë(„Åô)„Éª„Åç(„Åà„Çã),ÂïÜ:„Ç∑„Éß„Ç¶„Éª„ÅÇ„Åç„Å™(„ÅÜ),Á´†:„Ç∑„Éß„Ç¶,Âãù:„Ç∑„Éß„Ç¶„Éª„Åã(„Å§)„Éª„Åæ„Åï(„Çã),‰πó:„Ç∏„Éß„Ç¶„Éª„ÅÆ(„Çã)„Éª„ÅÆ(„Åõ„Çã),Ê§ç:„Ç∑„Éß„ÇØ„Éª„ÅÜ(„Åà„Çã)„Éª„ÅÜ(„Çè„Çã),Áî≥:„Ç∑„É≥„Éª„ÇÇ„ÅÜ(„Åô),Ë∫´:„Ç∑„É≥„Éª„Åø,Á•û:„Ç∑„É≥„Éª„Ç∏„É≥„Éª„Åã„Åø,Áúü:„Ç∑„É≥„Éª„Åæ„Éª„Åæ„Åì„Å®,Ê∑±:„Ç∑„É≥„Éª„Åµ„Åã(„ÅÑ)„Éª„Åµ„Åã(„Åæ„Çã)„Éª„Åµ„Åã(„ÇÅ„Çã),ÈÄ≤:„Ç∑„É≥„Éª„Åô„Åô(„ÇÄ)„Éª„Åô„Åô(„ÇÅ„Çã),‰∏ñ:„Çª„Ç§„Éª„Çª„Éª„Çà,Êï¥:„Çª„Ç§„Éª„Å®„Å®„ÅÆ(„Åà„Çã)„Éª„Å®„Å®„ÅÆ(„ÅÜ),Êòî:„Çª„Ç≠„Éª„Ç∑„É£„ÇØ„Éª„ÇÄ„Åã„Åó,ÂÖ®:„Çº„É≥„Éª„Åæ„Å£„Åü(„Åè)„Éª„Åô„Åπ(„Å¶),Áõ∏:„ÇΩ„Ç¶„Éª„Ç∑„Éß„Ç¶„Éª„ÅÇ„ÅÑ,ÈÄÅ:„ÇΩ„Ç¶„Éª„Åä„Åè(„Çã),ÊÉ≥:„ÇΩ„Ç¶„Éª„ÇΩ„Éª„Åä„ÇÇ(„ÅÜ),ÊÅØ:„ÇΩ„ÇØ„Éª„ÅÑ„Åç,ÈÄü:„ÇΩ„ÇØ„Éª„ÅØ„ÇÑ(„ÅÑ)„Éª„ÅØ„ÇÑ(„ÇÅ„Çã)„Éª„Åô„Åø(„ÇÑ„Åã),Êóè:„Çæ„ÇØ,‰ªñ:„Çø„Éª„Åª„Åã,Êâì:„ÉÄ„Éª„ÅÜ(„Å§),ÂØæ:„Çø„Ç§„Éª„ÉÑ„Ç§,ÂæÖ:„Çø„Ç§„Éª„Åæ(„Å§),‰ª£:„ÉÄ„Ç§„Éª„Çø„Ç§„Éª„Åã(„Çè„Çã)„Éª„Åã(„Åà„Çã)„Éª„Çà„Éª„Åó„Çç,Á¨¨:„ÉÄ„Ç§,È°å:„ÉÄ„Ç§,ÁÇ≠:„Çø„É≥„Éª„Åô„Åø,Áü≠:„Çø„É≥„Éª„Åø„Åò„Åã(„ÅÑ),Ë´á:„ÉÄ„É≥,ÁùÄ:„ÉÅ„É£„ÇØ„Éª„Ç∏„É£„ÇØ„Éª„Åç(„Çã)„Éª„Åç(„Åõ„Çã)„Éª„Å§(„Åè),Ê≥®:„ÉÅ„É•„Ç¶„Éª„Åù„Åù(„Åê),Êü±:„ÉÅ„É•„Ç¶„Éª„ÅØ„Åó„Çâ,‰∏Å:„ÉÅ„Éß„Ç¶„Éª„ÉÜ„Ç§,Â∏≥:„ÉÅ„Éß„Ç¶,Ë™ø:„ÉÅ„Éß„Ç¶„Éª„Åó„Çâ(„Åπ„Çã)„Éª„Å®„Å®„ÅÆ(„ÅÜ)„Éª„Å®„Å®„ÅÆ(„Åà„Çã),ËøΩ:„ÉÑ„Ç§„Éª„Åä(„ÅÜ),ÂÆö:„ÉÜ„Ç§„Éª„Ç∏„Éß„Ç¶„Éª„Åï„Å†(„ÇÅ„Çã)„Éª„Åï„Å†(„Åæ„Çã)„Éª„Åï„Å†(„Åã),Â∫≠:„ÉÜ„Ç§„Éª„Å´„Çè,Á¨õ:„ÉÜ„Ç≠„Éª„Åµ„Åà,ÈâÑ:„ÉÜ„ÉÑ,Ëª¢:„ÉÜ„É≥„Éª„Åì„Çç(„Å∂)„Éª„Åì„Çç(„Åå„Çã)„Éª„Åì„Çç(„Åí„Çã)„Éª„Åì„Çç(„Åå„Åô),ÈÉΩ:„Éà„Éª„ÉÑ„Éª„Åø„ÇÑ„Åì,Â∫¶:„Éâ„Éª„Éà„Éª„Çø„ÇØ„Éª„Åü„Å≥,Êäï:„Éà„Ç¶„Éª„Å™(„Åí„Çã),Ë±Ü:„Éà„Ç¶„Éª„Ç∫„Éª„Åæ„ÇÅ,Â≥∂:„Éà„Ç¶„Éª„Åó„Åæ,ÊπØ:„Éà„Ç¶„Éª„ÇÜ,Áôª:„Éà„Ç¶„Éª„Éà„Éª„ÅÆ„Åº(„Çã),Á≠â:„Éà„Ç¶„Éª„Å≤„Å®(„Åó„ÅÑ),Âãï:„Éâ„Ç¶„Éª„ÅÜ„Åî(„Åè)„Éª„ÅÜ„Åî(„Åã„Åô),Á´•:„Éâ„Ç¶„Éª„Çè„Çâ„Åπ,Ëæ≤:„Éé„Ç¶,Ê≥¢:„Éè„Éª„Å™„Åø,ÈÖç:„Éè„Ç§„Éª„Åè„Å∞(„Çã),ÂÄç:„Éê„Ç§,ÁÆ±:„ÅØ„Åì,Áïë:„ÅØ„Åü„Åë,Áô∫:„Éè„ÉÑ„Éª„Éõ„ÉÑ,Âèç:„Éè„É≥„Éª„Éõ„É≥„Éª„ÇΩ„É™„Éª„Åù(„Çã),ÂùÇ:„Éè„É≥„Éª„Åï„Åã,Êùø:„Éè„É≥„Éª„Éê„É≥„Éª„ÅÑ„Åü,ÁöÆ:„Éí„Éª„Åã„Çè,ÊÇ≤:„Éí„Éª„Åã„Å™(„Åó„ÅÑ)„Éª„Åã„Å™(„Åó„ÇÄ),Áæé:„Éì„Éª„ÅÜ„Å§„Åè(„Åó„ÅÑ),Èºª:„Éì„Éª„ÅØ„Å™,Á≠Ü:„Éí„ÉÑ„Éª„Åµ„Åß,Ê∞∑:„Éí„Éß„Ç¶„Éª„Åì„Åä„Çä„Éª„Å≤,Ë°®:„Éí„Éß„Ç¶„Éª„Åä„ÇÇ„Å¶„Éª„ÅÇ„Çâ„Çè(„Åô)„Éª„ÅÇ„Çâ„Çè(„Çå„Çã),Áßí:„Éì„Éß„Ç¶,ÁóÖ:„Éì„Éß„Ç¶„Éª„Éò„Ç§„Éª„ÇÑ„Åæ„ÅÑ,ÂìÅ:„Éí„É≥„Éª„Åó„Å™,Ë≤†:„Éï„Éª„Åæ(„Åë„Çã)„Éª„Åæ(„Åã„Åô)„Éª„Åä(„ÅÜ),ÈÉ®:„Éñ,Êúç:„Éï„ÇØ,Á¶è:„Éï„ÇØ,Áâ©:„Éñ„ÉÑ„Éª„É¢„ÉÑ„Éª„ÇÇ„ÅÆ,Âπ≥:„Éò„Ç§„Éª„Éì„Éß„Ç¶„Éª„Åü„ÅÑ(„Çâ)„Éª„Å≤„Çâ,Ëøî:„Éò„É≥„Éª„Åã„Åà(„Åô)„Éª„Åã„Åà(„Çã),Âãâ:„Éô„É≥,Êîæ:„Éõ„Ç¶„Éª„ÅØ„Å™(„Åô)„Éª„ÅØ„Å™(„Å§)„Éª„ÅØ„Å™(„Çå„Çã),Âë≥:„Éü„Éª„ÅÇ„Åò„Éª„ÅÇ„Åò(„Çè„ÅÜ),ÂëΩ:„É°„Ç§„Éª„Éü„Éß„Ç¶„Éª„ÅÑ„ÅÆ„Å°,Èù¢:„É°„É≥„Éª„Éô„É≥„Éª„Åä„ÇÇ„Éª„Åä„ÇÇ„Å¶„Éª„Å§„Çâ,Âïè:„É¢„É≥„Éª„Å®(„ÅÜ)„Éª„Å®(„ÅÑ),ÂΩπ:„É§„ÇØ„Éª„Ç®„Ç≠,Ëñ¨:„É§„ÇØ„Éª„Åè„Åô„Çä,Áî±:„É¶„Éª„É¶„Ç¶„Éª„É®„Ç∑,Ê≤π:„É¶„Éª„ÅÇ„Å∂„Çâ,Êúâ:„É¶„Ç¶„Éª„Ç¶„Éª„ÅÇ(„Çã),ÈÅä:„É¶„Ç¶„Éª„É¶„Éª„ÅÇ„Åù(„Å∂),‰∫à:„É®,Áæä:„É®„Ç¶„Éª„Å≤„Å§„Åò,Ê¥ã:„É®„Ç¶,Ëëâ:„É®„Ç¶„Éª„ÅØ,ÈôΩ:„É®„Ç¶„Éª„Å≤,Êßò:„É®„Ç¶„Éª„Åï„Åæ,ËêΩ:„É©„ÇØ„Éª„Åä(„Å°„Çã)„Éª„Åä(„Å®„Åô),ÊµÅ:„É™„É•„Ç¶„Éª„É´„Éª„Å™„Åå(„Çå„Çã)„Éª„Å™„Åå(„Åô),ÊóÖ:„É™„Éß„Éª„Åü„Å≥,‰∏°:„É™„Éß„Ç¶,Á∑ë:„É™„Éß„ÇØ„Éª„É≠„ÇØ„Éª„Åø„Å©„Çä,Á§º:„É¨„Ç§„Éª„É©„Ç§,Âàó:„É¨„ÉÑ,Á∑¥:„É¨„É≥„Éª„Å≠(„Çã),Ë∑Ø:„É≠„Éª„Åò„Éª„Åø„Å°,Âíå:„ÉØ„Éª„Ç™„Éª„ÇÑ„Çè(„Çâ„Åê)„Éª„ÇÑ„Çè(„Çâ„Åí„Çã)„Éª„Å™„Åî(„ÇÄ)„Éª„Å™„Åî(„ÇÑ„Åã)";
        
        // „Éá„Éº„ÇøËß£Êûê
        const kanjiData = kanjiString.split(',').map(item => {
            const parts = item.split(':');
            return { char: parts[0], reading: parts[1] };
        });

        // ‰øùÂ≠ò„Éá„Éº„Çø„ÅÆ„Ç≠„Éº„Çí„Äåv3„Äç„Å´Â§âÊõ¥„Åó„Å¶„ÄÅ‰ª•Ââç„ÅÆ„Éá„Éº„Çø„Å®Ê∑∑„Åñ„Çâ„Å™„ÅÑ„Çà„ÅÜ„Å´„Åó„Åæ„Åô
        let progressPractice = JSON.parse(localStorage.getItem('kanjiMasterPractice_Grade3_v3')) || {};
        let progressTest = JSON.parse(localStorage.getItem('kanjiMasterTest_Grade3_v3')) || {};
        
        let writer;
        let currentChar = null;
        let currentMode = 'practice';

        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
            if (screenId === 'list-screen') {
                document.getElementById('search-input').value = '';
                renderList();
            }
        }

        function selectMode(mode) {
            currentMode = mode;
            showScreen('list-screen');
        }

        function renderList() {
            const grid = document.getElementById('kanji-grid');
            grid.innerHTML = '';
            
            const badge = document.getElementById('mode-display');
            const counter = document.getElementById('star-counter');
            const targetProgress = (currentMode === 'practice') ? progressPractice : progressTest;

            if (currentMode === 'practice') {
                badge.textContent = "‚≠ê „Çå„Çì„Åó„ÇÖ„ÅÜ";
                badge.style.backgroundColor = "#FFCA28";
                badge.style.color = "#333";
            } else {
                badge.textContent = "üëë „ÉÜ„Çπ„Éà";
                badge.style.backgroundColor = "#FF7043";
                badge.style.color = "#FFF";
            }

            let totalCount = 0;
            kanjiData.forEach(item => {
                if (targetProgress[item.char]) totalCount++;
            });
            counter.innerText = totalCount;

            const searchText = document.getElementById('search-input').value;
            const filteredData = kanjiData.filter(item => {
                return item.char.includes(searchText) || item.reading.includes(searchText);
            });

            if (filteredData.length === 0) {
                grid.innerHTML = '<div style="grid-column: 1/-1; text-align:center; color:#888; margin-top:20px;">„Åø„Å§„Åã„Çä„Åæ„Åõ„Çì...</div>';
                return;
            }

            filteredData.forEach(item => {
                const isCleared = targetProgress[item.char];
                const card = document.createElement('div');
                card.className = `kanji-card`;
                if (isCleared) {
                    card.classList.add(currentMode === 'practice' ? 'cleared-practice' : 'cleared-test');
                }
                card.innerHTML = `${item.char}<div class="mark star-mark">‚≠ê</div><div class="mark crown-mark">üëë</div>`;
                card.onclick = () => startApp(item);
                grid.appendChild(card);
            });
        }

        function startApp(item) {
            currentChar = item;
            showScreen('practice-screen');
            document.getElementById('result-overlay').classList.remove('active');

            const screen = document.getElementById('practice-screen');
            const msgArea = document.getElementById('message-area');
            const titleDisplay = document.getElementById('current-kanji-title');
            const readingDisplay = document.getElementById('current-reading-detail');
            
            // Ë™≠„ÅøË°®Á§∫„ÇíÊï¥„Åà„ÇãÔºàÈü≥Ë™≠„Åø„ÅØ„Ç´„Çø„Ç´„Éä„ÄÅË®ìË™≠„Åø„ÅØ„Å≤„Çâ„Åå„Å™Ôºâ
            const readingText = item.reading;

            if (currentMode === 'test') {
                screen.classList.add('test-bg');
                msgArea.innerText = "„Åì„ÅÆ „Åã„Çì„Åò „Çí „Åã„Åì„ÅÜÔºÅ";
                msgArea.style.color = "#D84315";
                
                titleDisplay.innerText = "Ôºü";
                // „ÉÜ„Çπ„Éà„É¢„Éº„Éâ„Åß„ÇÇË™≠„Åø„ÇíË°®Á§∫Ôºà„Éí„É≥„Éà„Å®„Åó„Å¶Ôºâ
                readingDisplay.innerText = readingText; 
                readingDisplay.style.fontSize = "1.2rem";
            } else {
                screen.classList.remove('test-bg');
                msgArea.innerText = "„ÅÜ„Åô„ÅÑ„Åõ„Çì„Çí „Å™„Åû„Çç„ÅÜÔºÅ";
                msgArea.style.color = "#0277BD";
                
                titleDisplay.innerText = item.char;
                readingDisplay.innerText = readingText;
                readingDisplay.style.fontSize = "1rem";
            }

            document.getElementById('character-target-div').innerHTML = '';
            document.getElementById('anim-star').style.display = 'none';
            document.getElementById('anim-crown').style.display = 'none';

            try {
                if (typeof HanziWriter === 'undefined') throw new Error("„Éç„ÉÉ„Éà„Å´„Å§„Å™„Åå„Å£„Å¶„ÅÑ„Åæ„Åõ„Çì");
                
                const isTest = (currentMode === 'test');
                writer = HanziWriter.create('character-target-div', item.char, {
                    width: 280, height: 280, padding: 10,
                    showOutline: !isTest,
                    strokeAnimationSpeed: 1, delayBetweenStrokes: 200,
                    radicalColor: '#1565C0', drawingWidth: 20,
                    outlineColor: '#DDD', strokeColor: '#333',
                    highlightColor: '#42A5F5', 
                    showHintAfterMisses: 1,
                    
                    charDataLoader: function(char, onComplete) {
                        fetch('https://cdn.jsdelivr.net/gh/mnako/hanzi-writer-data-ja@master/data/' + char + '.json')
                            .then(res => {
                                if (!res.ok) throw new Error('JP Data Not Found');
                                return res.json();
                            })
                            .then(data => onComplete(data))
                            .catch(err => {
                                fetch('https://cdn.jsdelivr.net/npm/hanzi-writer-data@latest/' + char + '.json')
                                    .then(res => res.json())
                                    .then(data => onComplete(data));
                            });
                    }
                });
                startQuiz();
            } catch (e) {
                alert("„Ç®„É©„Éº: " + e.message);
            }
        }

        function startQuiz() {
            writer.quiz({
                onMistake: function() {
                    const msg = document.getElementById('message-area');
                    msg.innerText = (currentMode === 'test') ? "„Åä„Åó„ÅÑÔºÅ „Éí„É≥„Éà„Çí„Åø„Å¶" : "„Åì„Åì„Å†„ÇàÔºÅ";
                    msg.style.color = "#D32F2F";
                },
                onCorrectStroke: function() {
                    const msg = document.getElementById('message-area');
                    msg.innerText = "„ÅÑ„ÅÑ„Å≠ÔºÅ";
                    msg.style.color = "#2E7D32";
                },
                onComplete: function() {
                    handleComplete();
                }
            });
        }

        function handleComplete() {
            const msg = document.getElementById('message-area');
            const resultTitle = document.getElementById('result-title-text');
            const titleDisplay = document.getElementById('current-kanji-title');

            if(currentMode === 'test') {
                titleDisplay.innerText = currentChar.char;
            }
            
            if (currentMode === 'practice') {
                msg.innerText = "„Åß„Åç„Åü„ÉºÔºÅ ‚≠ê„Ç≤„ÉÉ„ÉàÔºÅ";
                resultTitle.innerText = "„Åß„Åç„Åü„ÉºÔºÅ‚≠ê"; 
                resultTitle.style.color = "#FBC02D";
                document.getElementById('anim-star').style.display = 'block';
                
                progressPractice[currentChar.char] = true;
                localStorage.setItem('kanjiMasterPractice_Grade3_v3', JSON.stringify(progressPractice));
            } else {
                msg.innerText = "„Åô„Åî„ÅÑÔºÅÔºÅ üëë„Ç≤„ÉÉ„ÉàÔºÅ";
                resultTitle.innerText = "„Åô„Åî„ÅÑÔºÅüëë"; 
                resultTitle.style.color = "#D84315";
                document.getElementById('anim-crown').style.display = 'block';
                
                progressTest[currentChar.char] = true;
                localStorage.setItem('kanjiMasterTest_Grade3_v3', JSON.stringify(progressTest));
            }

            setTimeout(() => {
                document.getElementById('result-overlay').classList.add('active');
            }, 1000);
        }

        function retry() { startApp(currentChar); }

        function goNext() {
            const searchText = document.getElementById('search-input').value;
            const filteredData = kanjiData.filter(item => {
                return item.char.includes(searchText) || item.reading.includes(searchText);
            });
            const currentIndex = filteredData.findIndex(k => k.char === currentChar.char);
            
            if (currentIndex >= 0 && currentIndex < filteredData.length - 1) {
                startApp(filteredData[currentIndex + 1]);
            } else {
                alert("„Åì„Çå„Åß„Åä„Åó„Åæ„ÅÑÔºÅ „Åô„Åî„ÅÑÔºÅ");
                showScreen('list-screen');
            }
        }

        function resetData() {
            if (confirm("„Åô„Åπ„Å¶„ÅÆ„Éá„Éº„Çø„Çí „Åë„Åó„Åæ„Åô„ÅãÔºü")) {
                localStorage.removeItem('kanjiMasterPractice_Grade3_v3');
                localStorage.removeItem('kanjiMasterTest_Grade3_v3');
                progressPractice = {};
                progressTest = {};
                renderList();
            }
        }
    </script>
</body>
</html>
